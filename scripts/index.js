!function(){function e(e){return Math.pow(e,2)}function t(){var e=$("#output").width(),t=$("#output").height();$("#input-proxy").val(h),d(),p=i(h),m=formFace.createInstance(p,{theme:g,letterHeight:e>600?72:36,densityMultiplier:window.devicePixelRatio});var a=m.getCanvas();m.draw(),$("#canvas-container").empty().append(a).css("height",a.offsetHeight+"px");var n=Math.min(1,Math.min(e/a.offsetWidth,t/a.offsetHeight));1>n?$("#canvas-container").css("transform","scale("+n+")"):$("#canvas-container").css("transform","");var o={};m._layoutPass(function(e,t){o=t});var r=m._padding;$("<div>").attr("id","cursor").css({left:(o.r+r)/window.devicePixelRatio+"px",top:(o.t+r)/window.devicePixelRatio+"px",height:(o.b-o.t)/window.devicePixelRatio+"px"}).appendTo("#canvas-container")}function a(){ga("set","dimension1",g.name),$("body").css("background-color",g.colorbg).addClass("theme-"+g.name),$("paper-fab").css("background-color",g.keyColor),$("#theme-changer").css("background-color",n().keyColor)}function n(){var e=0;for(e=0;e<formFace.THEMES.length&&g!=formFace.THEMES[e];e++);return++e,e>=formFace.THEMES.length&&(e=0),formFace.THEMES[e]}function o(e,t,a){if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,a);else if(e.createTextRange){var n=e.createTextRange();n.collapse(!0),n.moveEnd("character",a),n.moveStart("character",t),n.select()}}function r(e,t){o(e,t,t)}function i(e){for(var t=(e||"").split(/\n/),a=[],n=0;n<t.length;n++){for(var o=t[n];o.length>b;){var r=o.lastIndexOf(" ",b);if(r>=0)console.log("found a space, wrap there"),a.push(o.substring(0,r)),o=o.substring(r+1);else{var i=o.indexOf(" ",b);if(!(i>=0))break;a.push(o.substring(0,i)),o=o.substring(i+1)}}a.push(o)}return a.join("\n")}function s(){switch(E){case x.NONE:m.setTime(0),m.draw(),E=x.DRAWING_FORWARD,y=Number(new Date)+500,m.setAnimInterpolator(e),F=window.setTimeout(s,500);break;case x.DRAWING_FORWARD:var t=Number(new Date)-y;m.setTime(t),m.draw(),t<m.getEndTime()&&(R=requestAnimationFrame(s))}}function c(e){e&&($("paper-progress").get(0).value=0,$("#accept-download-button").hide().attr("href","")),v=e,$("#download-dialog").removeClass("before-show").get(0).opened=e}function d(){F&&window.clearTimeout(F),R&&window.cancelAnimationFrame(R)}var l=navigator.userAgent.toLowerCase(),u=l.indexOf("mobile")>=0,f=l.indexOf("android")>=0,g=(Modernizr.touch,formFace.THEME_DEFAULT),h="",p="",m=null,v=!1,w=!1;$(window).resize(t),Modernizr.touch&&$("#output").addClass("virtualkeyboard"),$("#input-proxy").on("input",function(){h=$(this).val();for(var e="",a=0;a<h.length;a++){var n=h.charCodeAt(a);formFace.hasGlyphForCharCode(n)&&(e+=h.charAt(a))}e!=h&&$(this).val(e),h=e,t()}).on("keydown",function(){var e=this;setTimeout(function(){var t=$(e).val().length;r(e,t)},0)}).on("focus",function(){$("#cursor").show()}).on("blur",function(){$("#cursor").hide()}),$("#theme-changer").click(function(){$("body").removeClass("theme-"+g.name),g=n(),t(),a()});var b=16,x={NONE:0,DRAWING_FORWARD:1},y=0,E=x.NONE,F=0,R=0;$("paper-fab").on("click",function(){ga("set","metric1",h.length),ga("send","event","play","button-press"),d(),E=x.NONE,s()}),$("#cancel-download-button").click(function(){w=!0,c(!1)}),$("#accept-download-button").click(function(){ga("send","event","download-complete","button");var e=$(this).data("href");e&&window.open(e,"_blank"),c(!1)}),$("#download-button").click(function(){function e(){var e=l>s;e&&(l=s),o.setTime(l),o.draw();var a=i.getImageData(0,0,r.width,r.height),n=1e3/m;0==l&&(n=1e3),e&&(n=5e3),t.postMessage({quality:100,lastFrame:e,frameIndex:d,progress:l/s,imgData:a.data,delay:n,width:r.width,height:r.height}),e||(++d,l+=1e3/m)}if(!v){ga("set","metric1",h.length),ga("send","event","download-start","button-press"),c(!0);var t,a=p.length>15||u?1.5:1,n=144/a,o=formFace.createInstance(p,{theme:g,letterHeight:72/a,padding:n}),r=o.getCanvas(),i=r.getContext("2d"),s=o.getEndTime(),d=0,l=0,m=20;t=new Worker("scripts/gifencodeworker.js"),t.onmessage=function(t){if(w)return w=!1,v=!1,void 0;if("progress"in t.data&&$("paper-progress").animate({value:100*t.data.progress},{duration:50}),t.data.complete){for(var a=t.data.frameData,n=new Uint8Array(a.length),o=0;o<a.length;++o)n[o]=a.charCodeAt(o);var r=(navigator.userAgent.toLowerCase(),!new Blob||u&&!f);if(r)$("#accept-download-button").data("href","data:image/gif;base64,"+encode64(a)).show();else{ga("send","event","download-complete","auto");var i=new Blob([n.buffer||n],{type:"image/gif"});saveAs(i,"FORMSF14.gif"),c(!1)}}else e()},w=!1,e()}}),$(function(){$("#input-proxy").focus(),t(),a()})}();